<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>センター南校登校スタンプラリー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; }
        .calendar-day { transition: all 0.3s ease; }
        .calendar-day.checked { background-color: #fef08a; color: #b45309; font-weight: 800; border-radius: 50%; position: relative; }
        .calendar-day.checked::after { content: '✔'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; color: #f59e0b; }
        .calendar-day.today { border: 2px solid #3b82f6; }
        .btn-shine { position: relative; overflow: hidden; }
        .btn-shine::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: rgba(255, 255, 255, 0.4); transform: rotate(45deg); transition: all 0.5s ease; opacity: 0; }
        .btn-shine:hover::after { left: 100%; opacity: 1; transition: all 0.5s ease; }
        #lottery-modal[data-result="win"] #win-content,
        #lottery-modal[data-result="lose"] #lose-content { display: block; }
        #lottery-modal #win-content,
        #lottery-modal #lose-content { display: none; }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8">
        <!-- ログイン画面 -->
        <div id="login-screen">
            <h1 class="text-3xl font-extrabold text-center text-blue-600 mb-2">センター南校<br>登校スタンプラリー</h1>
            <p class="text-center text-gray-500 mb-8">IDとパスワードでログインしてね！</p>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="ID" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                <input type="password" id="password" placeholder="パスワード" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
            </div>
            <button onclick="login()" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 btn-shine">ログイン</button>
            <p id="login-error" class="text-red-500 text-center mt-4 h-5"></p>
        </div>

        <!-- メイン画面 -->
        <div id="main-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div><h2 class="text-2xl font-bold text-gray-800">こんにちは、<span id="user-name"></span> さん！</h2><p class="text-gray-500">今日もがんばろう！</p></div>
                <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-500 transition-colors">ログアウト</button>
            </div>
            
            <!-- ★★★ ここから表示エリアを追加 ★★★ -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-100 rounded-lg p-4 text-center">
                    <p class="text-blue-800 text-sm">合計登校日数</p>
                    <p class="text-3xl font-extrabold text-blue-600"><span id="login-count">0</span> 日</p>
                </div>
                <div class="bg-yellow-100 rounded-lg p-4 text-center">
                    <p class="text-yellow-800 text-sm">景品交換チケット</p>
                    <p class="text-3xl font-extrabold text-yellow-600"><span id="prize-ticket-count">0</span> 枚</p>
                </div>
            </div>
            <!-- ★★★ ここまで ★★★ -->

            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="toko-btn" onclick="recordAttendance('toko')" class="bg-green-500 text-white font-bold py-4 rounded-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105 btn-shine">登校する</button>
                <button id="geko-btn" onclick="recordAttendance('geko')" class="bg-orange-500 text-white font-bold py-4 rounded-lg hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 btn-shine" disabled>下校する</button>
            </div>
            <div id="calendar" class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-4"><button id="prev-month" class="text-gray-600 hover:text-blue-500">&lt;</button><h3 id="calendar-header" class="text-lg font-bold text-gray-700"></h3><button id="next-month" class="text-gray-600 hover:text-blue-500">&gt;</button></div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>
        </div>
    </div>

    <!-- 抽選モーダル -->
    <div id="lottery-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center transform transition-all scale-95 opacity-0">
            <div id="win-content"><h2 class="text-5xl font-extrabold text-red-500 mb-4 animate-bounce">あたり！</h2><p class="text-yellow-500 text-8xl mb-4">🎉</p><p class="text-gray-700 text-lg mb-6">おめでとう！景品チケットを1枚ゲット！</p></div>
            <div id="lose-content"><h2 class="text-5xl font-extrabold text-blue-500 mb-4">ざんねん！</h2><p class="text-blue-400 text-8xl mb-4">💧</p><p class="text-gray-700 text-lg mb-6">また明日チャレンジしてね！</p></div>
            <button onclick="closeLottery()" class="w-full mt-4 bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition-colors">とじる</button>
        </div>
    </div>

    <script>
        // --- 設定 ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwHO7Tk0zEyUHMSHwXfefFdrdncIcymSzZaRIOxCDzMUEpCrXQnZNKjSYEC863DYEpE/exec'; // GASのデプロイURL

        // --- グローバル変数 ---
        let currentUser = null;
        let currentMonth = new Date();
        let attendanceDates = [];

        // --- DOM要素 ---
        const loginScreen = document.getElementById('login-screen');
        const mainScreen = document.getElementById('main-screen');
        const loginError = document.getElementById('login-error');
        const userNameEl = document.getElementById('user-name');
        const loginCountEl = document.getElementById('login-count');
        const prizeTicketCountEl = document.getElementById('prize-ticket-count'); // ★追加
        const tokoBtn = document.getElementById('toko-btn');
        const gekoBtn = document.getElementById('geko-btn');
        const lotteryModal = document.getElementById('lottery-modal');

        // --- JSONP通信関数 ---
        function jsonpRequest(url, callbackName, callback) {
            window[callbackName] = callback;
            const script = document.createElement('script');
            script.src = url;
            document.body.appendChild(script);
            script.onload = () => {
                document.body.removeChild(script);
                delete window[callbackName];
            };
            script.onerror = () => {
                loginError.textContent = '通信エラーが発生しました。';
                document.body.removeChild(script);
                delete window[callbackName];
            };
        }

        /**
         * ログイン処理【景品枚数表示を追加】
         */
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            loginError.textContent = 'ログイン中...';

            if (!username || !password) {
                loginError.textContent = 'IDとパスワードを入力してください。';
                return;
            }

            const callbackName = 'loginCallback';
            const url = `${GAS_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
            
            jsonpRequest(url, callbackName, (result) => {
                if (result.success) {
                    currentUser = result.user;
                    attendanceDates = result.attendanceDates || [];
                    userNameEl.textContent = currentUser.name;
                    loginCountEl.textContent = attendanceDates.length;
                    prizeTicketCountEl.textContent = result.prizeTickets || 0; // ★追加
                    
                    loginScreen.classList.add('hidden');
                    mainScreen.classList.remove('hidden');
                    
                    updateCalendar();
                    updateButtonState();
                    loginError.textContent = '';
                } else {
                    loginError.textContent = result.message || 'ログインに失敗しました。';
                }
            });
        }

        /**
         * ログアウト処理
         */
        function logout() {
            currentUser = null;
            attendanceDates = [];
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            mainScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        /**
         * 登下校記録と抽選【景品枚数更新を追加】
         */
        function recordAttendance(type) {
            const button = type === 'toko' ? tokoBtn : gekoBtn;
            button.disabled = true;
            button.textContent = '記録中...';

            const callbackName = 'attendanceCallback';
            const url = `${GAS_URL}?action=recordAttendance&userId=${encodeURIComponent(currentUser.id)}&type=${type}&callback=${callbackName}`;

            jsonpRequest(url, callbackName, (result) => {
                if (result.success) {
                    if (type === 'toko') {
                        attendanceDates = result.attendanceDates;
                        loginCountEl.textContent = attendanceDates.length;
                        
                        // ★追加：当たった場合に画面の枚数も増やす
                        if (result.lotteryResult === 'win') {
                            const currentTickets = parseInt(prizeTicketCountEl.textContent, 10);
                            prizeTicketCountEl.textContent = currentTickets + 1;
                        }
                        showLotteryResult(result.lotteryResult);
                    }
                    updateCalendar();
                    updateButtonState();
                } else {
                    alert(result.message || '記録に失敗しました。');
                }
                button.textContent = type === 'toko' ? '登校する' : '下校する';
            });
        }
        
        // --- 以下、UI関連の関数は変更なし ---
        function updateButtonState() {
            const today = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            const hasAttendedToday = attendanceDates.includes(today);
            tokoBtn.disabled = hasAttendedToday;
            gekoBtn.disabled = !hasAttendedToday;
        }

        function showLotteryResult(result) {
            lotteryModal.dataset.result = result;
            lotteryModal.classList.remove('hidden');
            setTimeout(() => { lotteryModal.querySelector('div').classList.remove('scale-95', 'opacity-0'); }, 10);
        }

        function closeLottery() {
            lotteryModal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { lotteryModal.classList.add('hidden'); }, 300);
        }

        function updateCalendar() {
            const calendarHeader = document.getElementById('calendar-header');
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            calendarHeader.textContent = `${year}年 ${month + 1}月`;
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'font-bold text-sm text-gray-500';
                if (day === '日') dayEl.classList.add('text-red-500');
                if (day === '土') dayEl.classList.add('text-blue-500');
                calendarGrid.appendChild(dayEl);
            });
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            for (let i = 0; i < firstDay; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = 'p-2 calendar-day';
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                if (attendanceDates.includes(currentDateStr)) { dayEl.classList.add('checked'); }
                if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) { dayEl.classList.add('today'); }
                calendarGrid.appendChild(dayEl);
            }
        }
        
        document.getElementById('prev-month').addEventListener('click', () => { currentMonth.setMonth(currentMonth.getMonth() - 1); updateCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { currentMonth.setMonth(currentMonth.getMonth() + 1); updateCalendar(); });
        document.getElementById('password').addEventListener('keypress', function(e) { if (e.key === 'Enter') { login(); } });
    </script>
</body>
</html>
